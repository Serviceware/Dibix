using System.Collections.Generic;
using System.Text.RegularExpressions;

namespace Dibix.Sdk.CodeGeneration
{
    public abstract class SqlWriter : IWriter
    {
        private const int TabSize = 4;
        private const string Header = @"/*------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//----------------------------------------------------------------------------*/";

        public string Write(string projectName, string @namespace, string className, SqlQueryOutputFormatting formatting, IList<SqlStatementInfo> statements)
        {
            StringWriter writer = new StringWriter();
            writer.WriteLineRaw(Header);
            this.Write(writer, projectName, @namespace, className, formatting, statements);
            return writer.ToString();
        }

        protected abstract void Write(StringWriter writer, string projectName, string @namespace, string className, SqlQueryOutputFormatting formatting, IList<SqlStatementInfo> statements);

        protected static string Format(string content, SqlQueryOutputFormatting formatting)
        {
            if (content == null)
                return null;

            string formatted = content.Trim();

            formatted = formatted.Replace("\t", new string(' ', TabSize));

            if (formatting.HasFlag(SqlQueryOutputFormatting.WhiteStripped))
                formatted = Regex.Replace(formatted, @"\s+", " ");

            if (formatting.HasFlag(SqlQueryOutputFormatting.StripDoubleQuotes))
                formatted = formatted.Replace("\"", formatting.HasFlag(SqlQueryOutputFormatting.Verbatim) ? "\"\"" : "\\\"");

            if (formatting.HasFlag(SqlQueryOutputFormatting.Minified))
                formatted = formatted.Replace("\r\n", @"\r\n");

            return formatted;
        }
    }
}