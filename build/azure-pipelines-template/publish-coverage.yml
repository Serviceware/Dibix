parameters:
- name: codeCoverageEngine
  type: string
  values:
  - Native
  - Cobertura

steps:
- download: current
  artifact: Test output (Windows)
  displayName: 📬 Download 'Test output (Windows)' artifact

- task: DotNetCoreCLI@2
  displayName: 📈 Install ReportGenerator
  inputs:
    command: custom
    custom: tool
    arguments: install --tool-path $(Agent.TempDirectory) dotnet-reportgenerator-globaltool

- script: >
    $(Agent.TempDirectory)/reportgenerator
    -reports:"$(Pipeline.Workspace)/Test output (Windows)/*.xml"
    -targetdir:"$(Pipeline.Workspace)/Test output (Windows)"
    -reporttypes:Cobertura
  displayName: 🔗 Merge code coverage results (*.xml)

# Can't seem to make  PublishCodeCoverageResults@2 accept spaces in the path for summaryFileLocation
- task: CopyFiles@2
  displayName: 🪂 Prepare Cobertura.xml
  inputs:
    SourceFolder: $(Pipeline.Workspace)\Test output (Windows)
    TargetFolder: $(Agent.TempDirectory)
    Contents: Cobertura.xml
- task: PublishCodeCoverageResults@2
  displayName: ☑️ Publish code coverage
  inputs:
    summaryFileLocation: $(Agent.TempDirectory)/Cobertura.xml
    pathToSources: $(Build.SourcesDirectory)
    failIfCoverageEmpty: true