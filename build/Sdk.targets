<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Suppress default DLL so we can use the same name -->
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>

    <DibixToolsDirectory Condition="$(DibixToolsDirectory) == ''">$(MSBuildThisFileDirectory)..\tools\net46\</DibixToolsDirectory>
    <DibixBuildToolsPath>$(DibixToolsDirectory)Dibix.MSBuild.dll</DibixBuildToolsPath>
    <DibixSdkPath>$(MSBuildThisFileDirectory)..\lib\net46\Dibix.Sdk.dll</DibixSdkPath>
  </PropertyGroup>

  <UsingTask TaskName="SqlCodeAnalysisTask" AssemblyFile="$(DibixBuildToolsPath)" />
  <UsingTask TaskName="CompileDatabaseAccessorTask" AssemblyFile="$(DibixBuildToolsPath)" />
  <UsingTask TaskName="VerifyDatabaseAccessorTask" AssemblyFile="$(DibixBuildToolsPath)" />

  <Target Name="SqlCodeAnalysis" BeforeTargets="BeforeBuild">
    <SqlCodeAnalysisTask SdkPath="$(DibixSdkPath)"
                         SSDTDirectory="$(SqlServerRedistPath)"
                         Inputs="@(Build->'%(FullPath)')" />
  </Target>

  <Target Name="CompileDatabaseAccessor" AfterTargets="PostBuildEvent" Condition="$(ShouldCompileDatabaseAccessor) == 'true'">
    <CompileDatabaseAccessorTask SdkPath="$(DibixSdkPath)"
                                 SSDTDirectory="$(SqlServerRedistPath)"
                                 ProjectDirectory="$(MSBuildProjectDirectory)"
                                 Namespace="$(DatabaseAccessorNamespace)"
                                 TargetDirectory="$(IntermediateOutputPath)"
                                 Inputs="@(Build)"
                                 ProbingDirectories="$(DibixProbingDirectories)"
                                 IsDML="$(IsDMLProject)">
      <Output TaskParameter="OutputFilePath" PropertyName="DatabaseAccessorPath" />
      <Output TaskParameter="ReferencePaths" PropertyName="DetectedDatabaseAccessorReferences" />
    </CompileDatabaseAccessorTask>

    <PropertyGroup>
      <DatabaseAccessorSources>
        $(DatabaseAccessorPath);
        $(DatabaseAccessorSources)
      </DatabaseAccessorSources>
      <DatabaseAccessorReferences>
        $(DibixToolsDirectory)Dibix.dll;
        $(DatabaseAccessorReferences);
        $(DetectedDatabaseAccessorReferences)
      </DatabaseAccessorReferences>
    </PropertyGroup>

    <Csc TargetType="library"
         Sources="$(DatabaseAccessorSources)"
         References="$(DatabaseAccessorReferences)"
         OutputAssembly="$(TargetPath)"
         EmitDebugInformation="$(DebugSymbols)" />
  </Target>

  <Target Name="VerifyDatabaseAccessor" BeforeTargets="PreBuildEvent">
    <VerifyDatabaseAccessorTask SdkPath="$(DibixSdkPath)"
                                ProjectDirectory="$(MSBuildProjectDirectory)"
                                Namespace="$(RootNamespace)"
                                AssemblyReferences="@(Reference->'%(HintPath)')"
                                Inputs="@(None)"
                                Condition="%(None.Generator) == 'Dibix'" />
  </Target>

</Project>