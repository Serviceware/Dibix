<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Suppress default DLL so we can use the same name -->
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>

    <DibixToolsDirectory Condition="$(DibixToolsDirectory) == ''">$(MSBuildThisFileDirectory)..\tools\net46\</DibixToolsDirectory>
    <DibixBuildToolsPath>$(DibixToolsDirectory)Dibix.MSBuild.dll</DibixBuildToolsPath>
    <DibixSdkPath>$(MSBuildThisFileDirectory)..\lib\net46\Dibix.Sdk.dll</DibixSdkPath>
  </PropertyGroup>

  <UsingTask TaskName="SqlCodeAnalysisTask" AssemblyFile="$(DibixBuildToolsPath)" />
  <UsingTask TaskName="CompileDatabaseAccessorTask" AssemblyFile="$(DibixBuildToolsPath)" />
  <UsingTask TaskName="VerifyDatabaseAccessorTask" AssemblyFile="$(DibixBuildToolsPath)" />

  <Target Name="SqlCodeAnalysis" BeforeTargets="BeforeBuild">
    <SqlCodeAnalysisTask SdkPath="$(DibixSdkPath)"
                         SSDTDirectory="$(SqlServerRedistPath)"
                         Inputs="@(Build->'%(FullPath)')"
                         IsIDEBuild="$(BuildingInsideVisualStudio)" />
  </Target>

  <Target Name="CompileDatabaseAccessor" AfterTargets="PostBuildEvent" Condition="$(ShouldCompileDatabaseAccessor) == 'true'">
    <PropertyGroup>
      <DatabaseAccessorNamespace Condition="'$(DatabaseAccessorNamespace)' == ''">$(RootNamespace)</DatabaseAccessorNamespace>
    </PropertyGroup>

    <ItemGroup>
      <Contracts Include="@(None)" Condition="'%(Extension)' == '.json'" />
    </ItemGroup>

    <CompileDatabaseAccessorTask SdkPath="$(DibixSdkPath)"
                                 SSDTDirectory="$(SqlServerRedistPath)"
                                 ProjectDirectory="$(MSBuildProjectDirectory)"
                                 Namespace="$(DatabaseAccessorNamespace)"
                                 TargetDirectory="$(IntermediateOutputPath)"
                                 Artifacts="@(Build)"
                                 Contracts="@(Contracts)"
                                 MultipleAreas="$(MultipleAreas)"
                                 DataLayerName="$(DataLayerName)"
                                 ContractsLayerName="$(ContractsLayerName)"
                                 IsIDEBuild="$(BuildingInsideVisualStudio)"
                                 IsDML="$(IsDMLProject)">
      <Output TaskParameter="OutputFilePath" PropertyName="DatabaseAccessorPath" />
    </CompileDatabaseAccessorTask>

    <PropertyGroup>
      <DatabaseAccessorSources>
        $(DatabaseAccessorPath);
        $(DatabaseAccessorSources)
      </DatabaseAccessorSources>
      <DatabaseAccessorReferences>
        $(DibixToolsDirectory)Dibix.dll;
        $(DatabaseAccessorReferences)
      </DatabaseAccessorReferences>
    </PropertyGroup>

    <Csc EmitDebugInformation="$(DebugSymbols)"
         KeyFile="$(AssemblyOriginatorKeyFile)"
         DefineConstants="$(DefineConstants)"
         LangVersion="latest"
         OutputAssembly="$(TargetPath)"
         References="$(DatabaseAccessorReferences)"
         Sources="$(DatabaseAccessorSources)"
         TargetType="library" />
  </Target>

  <Target Name="VerifyDatabaseAccessor" BeforeTargets="PreBuildEvent">
    <VerifyDatabaseAccessorTask SdkPath="$(DibixSdkPath)"
                                SSDTDirectory="$(SqlServerRedistPath)"
                                ProjectDirectory="$(MSBuildProjectDirectory)"
                                Namespace="$(RootNamespace)"
                                AssemblyReferences="@(Reference->'%(HintPath)')"
                                Inputs="@(None)"
                                Condition="%(None.Generator) == 'Dibix'"
                                IsIDEBuild="$(BuildingInsideVisualStudio)" />
  </Target>

</Project>