<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- 
      Skip compilation of default SQL CLR .NET assembly.
      The empty line in between by default contains:
      
      CoreCompile;
    -->
    <BuildDependsOn>
      BuildOnlySettings;
      BeforeBuild;
      PrepareForBuild;
      PreBuildEvent;
      ResolveReferences;
      ResolveArtifactReferences;
      GenerateSqlTargetFrameworkMoniker;
      ResolveKeySource;

      GenerateSerializationAssemblies;
      SqlBuild;
      GetTargetPath;
      PrepareForRun;
      SqlPrepareForRun;
      IncrementalClean;
      PostBuildEvent;
      AfterBuild;
    </BuildDependsOn>

    <!-- 
      Skip copying the default SQL CLR .NET assembly to output.
      The empty line in between by default contains:
      
      CopyFilesToOutputDirectory;
    -->
    <PrepareForRunDependsOn>

      RunCodeAnalysis;
      SqlRunCodeAnalysis
    </PrepareForRunDependsOn>
    
    <DibixToolsDirectory Condition="$(DibixToolsDirectory) == ''">$(MSBuildThisFileDirectory)..\tools\net46\</DibixToolsDirectory>
    <DibixBuildToolsPath>$(DibixToolsDirectory)Dibix.MSBuild.dll</DibixBuildToolsPath>
    <DibixSdkPath>$(MSBuildThisFileDirectory)..\lib\net46\Dibix.Sdk.dll</DibixSdkPath>
  </PropertyGroup>

  <UsingTask TaskName="SqlCodeAnalysisTask" AssemblyFile="$(DibixBuildToolsPath)" />
  <UsingTask TaskName="CompileDatabaseAccessorTask" AssemblyFile="$(DibixBuildToolsPath)" />
  <UsingTask TaskName="VerifyDatabaseAccessorTask" AssemblyFile="$(DibixBuildToolsPath)" />

  <Target Name="SqlCodeAnalysis" BeforeTargets="BeforeBuild">
    <SqlCodeAnalysisTask SdkPath="$(DibixSdkPath)"
                         SSDTDirectory="$(SqlServerRedistPath)"
                         Inputs="@(Build->'%(FullPath)')"
                         IsIDEBuild="$(BuildingInsideVisualStudio)" />
  </Target>

  <Target Name="CompileDatabaseAccessor" AfterTargets="PostBuildEvent" Condition="$(ShouldCompileDatabaseAccessor) == 'true'">
    <PropertyGroup>
      <LangVersion>latest</LangVersion>
      <CopyBuildOutputToOutputDirectory>true</CopyBuildOutputToOutputDirectory>
      <CopyOutputSymbolsToOutputDirectory>true</CopyOutputSymbolsToOutputDirectory>
      <DatabaseAccessorNamespace Condition="'$(DatabaseAccessorNamespace)' == ''">$(RootNamespace)</DatabaseAccessorNamespace>
    </PropertyGroup>

    <ItemGroup>
      <Contract Include="@(None)" Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(RelativeDir)', '^Contracts\\')) and %(Extension) == '.json'" />
      <Endpoint Include="@(None)" Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(RelativeDir)', '^Endpoints\\')) and %(Extension) == '.json'" />
    </ItemGroup>

    <CompileDatabaseAccessorTask SdkPath="$(DibixSdkPath)"
                                 SSDTDirectory="$(SqlServerRedistPath)"
                                 ProjectDirectory="$(MSBuildProjectDirectory)"
                                 Namespace="$(DatabaseAccessorNamespace)"
                                 TargetDirectory="$(IntermediateOutputPath)"
                                 Artifacts="@(Build)"
                                 Contracts="@(Contract)"
                                 Endpoints="@(Endpoint)"
                                 MultipleAreas="$(MultipleAreas)"
                                 IsIDEBuild="$(BuildingInsideVisualStudio)"
                                 IsDML="$(IsDMLProject)">
      <Output TaskParameter="OutputFilePath" ItemName="DatabaseAccessorSource" />
      <Output TaskParameter="DetectedReferences" ItemName="DatabaseAccessorReference" />
    </CompileDatabaseAccessorTask>

    <ItemGroup>
      <DatabaseAccessorReference Include="$(DibixToolsDirectory)Dibix.dll" />
      <DatabaseAccessorReference Include="@(ArtifactReference->'%(RelativeDir)%(Filename).dll')" />
    </ItemGroup>

    <Csc DefineConstants="$(DefineConstants)"
         EmitDebugInformation="$(DebugSymbols)"
         KeyFile="$(AssemblyOriginatorKeyFile)"
         LangVersion="$(LangVersion)"
         OutputAssembly="@(IntermediateAssembly)"
         References="@(DatabaseAccessorReference)"
         Sources="@(DatabaseAccessorSource)"
         TargetType="$(OutputType)" />

    <!-- Copy the build product (.dll or .exe). -->
    <Copy SourceFiles="@(IntermediateAssembly)"
          DestinationFolder="$(OutDir)"
          SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
          OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
          Retries="$(CopyRetryCount)"
          RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
          UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
          UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
          Condition="'$(CopyBuildOutputToOutputDirectory)' == 'true' and '$(SkipCopyBuildProduct)' != 'true'">
      <Output TaskParameter="DestinationFiles" ItemName="MainAssembly"/>
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
    </Copy>
 
    <!-- Copy the debug information file (.pdb), if any -->
    <Copy SourceFiles="@(_DebugSymbolsIntermediatePath)"
          DestinationFiles="@(_DebugSymbolsOutputPath)"
          SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
          OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
          Retries="$(CopyRetryCount)"
          RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
          UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
          UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
          Condition="'$(_DebugSymbolsProduced)'=='true' and '$(SkipCopyingSymbolsToOutputDirectory)' != 'true' and '$(CopyOutputSymbolsToOutputDirectory)'=='true'">
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
    </Copy>
  </Target>

  <Target Name="VerifyDatabaseAccessor" BeforeTargets="PreBuildEvent">
    <VerifyDatabaseAccessorTask SdkPath="$(DibixSdkPath)"
                                SSDTDirectory="$(SqlServerRedistPath)"
                                ProjectDirectory="$(MSBuildProjectDirectory)"
                                Namespace="$(RootNamespace)"
                                AssemblyReferences="@(Reference->'%(HintPath)')"
                                Inputs="@(None)"
                                Condition="%(None.Generator) == 'Dibix'"
                                IsIDEBuild="$(BuildingInsideVisualStudio)" />
  </Target>

</Project>